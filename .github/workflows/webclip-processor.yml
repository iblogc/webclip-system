name: Web Clip Processor

on:
  schedule:
    - cron: '0 6-23 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œå¤„ç†å™¨'
        required: false
        default: 'false'
        type: boolean
      custom_cron:
        description: 'è‡ªå®šä¹‰cronè¡¨è¾¾å¼ï¼ˆç”¨äºæµ‹è¯•ï¼‰'
        required: false
        type: string

env:
  NODE_VERSION: '18'

jobs:
  process-webclips:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # å¢åŠ è¶…æ—¶æ—¶é—´åˆ°45åˆ†é’Ÿ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Gist content (fast pre-check)
      id: check_content
      run: |
        chmod +x scripts/check-gist-content.sh
        bash scripts/check-gist-content.sh
      env:
        GIST_ID: ${{ secrets.GIST_ID }}
        TOKEN: ${{ secrets.TOKEN }}
        
    - name: Setup Node.js
      if: steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      if: steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true'
      run: |
        npm ci
        # å®‰è£…GitHub Actionsä¸“ç”¨ä¾èµ–
        npm install @actions/core @actions/github nodemailer
        
    - name: Skip if no content
      if: steps.check_content.outputs.should_process == 'false' && github.event.inputs.force_run != 'true'
      run: |
        echo "ğŸ“­ Gistå†…å®¹ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†ä»¥èŠ‚çœèµ„æº"
        echo "è·³è¿‡åŸå› : ${{ steps.check_content.outputs.skip_reason }}"
        echo "å¦‚éœ€å¼ºåˆ¶è¿è¡Œï¼Œè¯·ä½¿ç”¨workflow_dispatchå¹¶è®¾ç½®force_runä¸ºtrue"
        exit 0
        
    - name: Setup Chrome for Puppeteer
      if: steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser
        
    - name: Generate dynamic configuration
      if: steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true'
      run: node scripts/setup-config.js
      env:
        GIST_ID: ${{ secrets.GIST_ID }}
        TOKEN: ${{ secrets.TOKEN }}
        TARGET_REPO: ${{ secrets.TARGET_REPO }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
        OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
        GEMINI_BASE_URL: ${{ secrets.GEMINI_BASE_URL }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL }}
        CLAUDE_BASE_URL: ${{ secrets.CLAUDE_BASE_URL }}
        HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
        HTTPS_PROXY: ${{ secrets.HTTPS_PROXY }}
        NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        ENABLE_AI_SUMMARY: ${{ secrets.ENABLE_AI_SUMMARY }}
        ENABLE_RESOURCE_DOWNLOAD: ${{ secrets.ENABLE_RESOURCE_DOWNLOAD }}
        
    - name: Process web clips
      id: process
      if: steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true'
      run: node scripts/actions-processor.js
      continue-on-error: true
      
    - name: Commit and push to target repository
      if: (steps.process.outcome == 'success' || steps.process.outcome == 'cancelled') && (steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true')
      run: node scripts/push-to-target.js
      env:
        TARGET_REPO: ${{ secrets.TARGET_REPO }}
        TOKEN: ${{ secrets.TOKEN }}
        
    - name: Send notification email
      if: steps.check_content.outputs.should_process == 'true' || github.event.inputs.force_run == 'true'
      run: node scripts/send-notification.js
      env:
        PROCESS_RESULT: ${{ steps.process.outcome || 'skipped' }}
        SKIP_REASON: ${{ steps.check_content.outputs.skip_reason }}
        CONTENT_SUMMARY: ${{ steps.check_content.outputs.content_summary }}
        NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
        EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        
    - name: Cleanup old workflow runs
      if: always()
      run: node scripts/cleanup-workflows.js
      env:
        TOKEN: ${{ secrets.TOKEN }}
        
    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          logs/
          temp/
        retention-days: 7